{% extends "base/layout.html" %}
{% load static %}

{% block content %}

<div class="content-wrapper">

    <!-- Breadcrumb -->
    <div class="breadcrumb-bar">
        <span class="text-muted">Fees</span>
        <span class="mx-2">|</span>
        <span class="fw-semibold">Fees Paid Receipt</span>
    </div>

    <!-- Card -->
    <div class="card fees-card max-w-xl mx-auto mt-8">

        <!-- Tab Header -->
        <div class="card-tab">
            <i class="bi bi-search"></i>
            <span>Fees Record</span>
        </div>

        <!-- Form -->
<form id="feeHistoryForm">

            <!-- Fees Month -->
            <div class="form-group">
                <label class="form-label">
                    Fees Month<span class="required">*</span>
                </label>
<input type="month" id="monthInput" class="form-control" required>

            </div>

            <!-- Search Student -->
             <!-- Class -->
<!-- Class -->
<div class="form-group">
    <label class="form-label">Class<span class="required">*</span></label>
    <select id="classSelect" class="form-control" required>
        <option value="">Select Class</option>
    </select>
</div>

<!-- Section -->
<div class="form-group">
    <label class="form-label">Section</label>
    <select id="sectionSelect" class="form-control">
        <option value="">Select Section</option>
    </select>
</div>

            <div class="form-group">
                <label class="form-label">
                    Search Student<span class="required">*</span>
                </label>
<input
  type="text"
  id="studentSearch"
  class="form-control"
  placeholder="Type student name or admission no"
>

<input type="hidden" id="studentId">
<ul id="studentResults" class="border rounded bg-white hidden"></ul>

            </div>

            <!-- Submit -->
            <div class="text-center mt-6">
                <button type="submit" class="btn btn-submit">
                    <i class="bi bi-receipt"></i>
                    Submit
                </button>
            </div>

        </form>
    </div>

</div>
<script>
function authHeaders() {
    const token = window.ACCESS_TOKEN;
    if (!token) {
        alert("Session expired. Please login again.");
        window.location.href = "/login/";
        throw new Error("No access token");
    }
    return {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
    };
}
</script>

<script>
    
const classSelect = document.getElementById("classSelect");
const sectionSelect = document.getElementById("sectionSelect");
const searchInput = document.getElementById("studentSearch");
const studentIdInput = document.getElementById("studentId");
const resultsBox = document.getElementById("studentResults");

let debounce;

/* ================= STUDENT SEARCH ================= */
searchInput.addEventListener("input", () => {
    clearTimeout(debounce);

    const q = searchInput.value.trim();
    const classId = classSelect.value;
    const section = sectionSelect.value;

    if (!classId) {
        alert("Please select class first");
        searchInput.value = "";
        return;
    }

    if (q.length < 2) {
        resultsBox.innerHTML = "";
        resultsBox.classList.add("hidden");
        return;
    }

    debounce = setTimeout(() => fetchStudents(q, classId, section), 300);
});

async function fetchStudents(q, classId, section) {
    const res = await fetch(
    `/students/search?q=${encodeURIComponent(q)}`,
    {
        headers: authHeaders()
    }
);


    const students = await res.json();
    resultsBox.innerHTML = "";

    const filtered = students.filter(s =>
        String(s.class_id) === String(classId) &&
        (!section || s.section === section)
    );

    if (filtered.length === 0) {
        resultsBox.innerHTML =
            `<li class="px-3 py-2 text-muted">No students found</li>`;
        resultsBox.classList.remove("hidden");
        return;
    }

    filtered.forEach(s => {
        const li = document.createElement("li");
        li.textContent =
            `${s.name} (Roll: ${s.roll_no}, Adm: ${s.admission_no})`;
        li.className = "px-3 py-2 hover:bg-gray-100 cursor-pointer";

        li.onclick = () => {
            searchInput.value = s.name;
            studentIdInput.value = s.id;
            resultsBox.classList.add("hidden");
        };

        resultsBox.appendChild(li);
    });

    resultsBox.classList.remove("hidden");
}

/* ================= CLEAR ON CLASS CHANGE ================= */
classSelect.addEventListener("change", () => {
    searchInput.value = "";
    studentIdInput.value = "";
    resultsBox.innerHTML = "";
    resultsBox.classList.add("hidden");
});
</script>
<script>
(async () => {
const res = await fetch("/classes/", {
    headers: authHeaders()
});
if (!res.ok) {
    console.error("Classes API failed", await res.text());
    return;
}
const classes = await res.json();

    const classSelect = document.getElementById("classSelect");
    classSelect.innerHTML = `<option value="">Select Class</option>`;

    classes.forEach(c => {
        classSelect.innerHTML +=
            `<option value="${c.id}">${c.name}</option>`;
    });
})();
</script>
<script>
document.getElementById("classSelect").addEventListener("change", async (e) => {
    const classId = e.target.value;
    const sectionSelect = document.getElementById("sectionSelect");

    sectionSelect.innerHTML = `<option value="">Select Section</option>`;

    if (!classId) return;

    const res = await fetch(`/sections/?class_id=${classId}`, {
    headers: authHeaders()
});

if (!res.ok) {
    console.error("Sections API failed", await res.text());
    return;
}

    const sections = await res.json();

    sections.forEach(sec => {
        sectionSelect.innerHTML +=
            `<option value="${sec.name}">${sec.name}</option>`;
    });
});
</script>

{% endblock %}
