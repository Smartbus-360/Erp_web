{% extends "base/layout.html" %}
{% block content %}

<div class="mb-6 text-sm text-gray-500">
  Classes / Sections
</div>

<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
  <div id="sectionsContainer" class="contents"></div>
  <!-- Timetable Modal -->
<div id="timetableModal"
     class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">

  <div class="bg-white w-full max-w-5xl rounded-xl p-6 relative">

    <button onclick="closeTimetable()"
            class="absolute top-3 right-3 text-gray-500 hover:text-black">
      ‚úï
    </button>

    <h2 id="timetableTitle"
        class="text-xl font-semibold mb-4">
    </h2>

    <div id="timetableContent"
         class="overflow-x-auto">
      <!-- timetable table injected here -->
    </div>

  </div>
</div>

</div>

{% block page_js %}
<script>
(async () => {

  const classId = window.location.pathname.split("/")[2];

  const res = await fetch(
    `https://erp.backend.smartbus360.com/classes/${classId}/sections/summary`,
    { headers: { Authorization: "Bearer " + window.ACCESS_TOKEN } }
  );

  const sections = await res.json();
  const container = document.getElementById("sectionsContainer");

  container.innerHTML = "";

  sections.forEach(sec => {
    container.innerHTML += `
  <div class="bg-white rounded-2xl p-6 border hover:shadow-lg transition duration-300 relative">

      <div class="absolute inset-x-0 top-0 h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 rounded-t-2xl"></div>

    <div class="flex items-center justify-between mt-2">
      <h3 class="text-xl font-semibold tracking-tight">
        Section ${sec.name}
      </h3>


<a href="/students/?class_id=${classId}&section=${sec.name}"
   class="text-xs bg-indigo-100 px-3 py-1 rounded-full">
   ${sec.students_count} Students
</a>

    </div>

    <div class="text-sm text-gray-600 mb-2">
  üë®‚Äçüè´
  ${
    sec.teacher_id
      ? `<a href="/employees/profile/?id=${sec.teacher_id}"
           class="text-indigo-600 hover:underline font-medium">
           ${sec.teacher_name}
         </a>`
      : "No Teacher Assigned"
  }
</div>


    <!-- Divider -->
    <hr class="my-4">

    <div class="mt-4 flex justify-end">
  <button
    onclick="openTimetable(${classId}, ${sec.id}, '${sec.name}')"
    class="text-sm px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition"
  >
    üìÖ View Timetable
  </button>
</div>

    <!-- Gender Analytics -->
    ${renderGender(sec)}

    <!-- Category Analytics -->
    ${renderCaste(sec)}

    <!-- Fees Analytics -->
${renderFees(sec)}

  </div>
`;

  });

})();

function renderGender(data) {
  return `
    <div class="mt-4">
      <div class="text-xs font-semibold text-gray-500 mb-2">
        Gender Distribution
      </div>

      <!-- Stacked Bar -->
      <div class="w-full h-8 flex rounded-lg overflow-hidden shadow-inner bg-gray-200">

        <!-- Boys -->
        <div
          class="bg-blue-500 flex items-center justify-center text-[11px] font-semibold text-white"
          style="width:${data.boys_percent}%"
          title="Boys ‚Äì ${data.boys_percent}%"
        >
          ${data.boys_percent >= 10 ? `Boys ${data.boys_percent}%` : ""}
        </div>

        <!-- Girls -->
        <div
          class="bg-pink-500 flex items-center justify-center text-[11px] font-semibold text-white"
          style="width:${data.girls_percent}%"
          title="Girls ‚Äì ${data.girls_percent}%"
        >
          ${data.girls_percent >= 10 ? `Girls ${data.girls_percent}%` : ""}
        </div>

      </div>

      <!-- Legend -->
      <div class="mt-2 flex gap-4 text-[10px] text-gray-600">
        <span class="flex items-center gap-1">
          <span class="w-2 h-2 rounded-full bg-blue-500"></span>
          Boys
        </span>
        <span class="flex items-center gap-1">
          <span class="w-2 h-2 rounded-full bg-pink-500"></span>
          Girls
        </span>
      </div>
    </div>
  `;
}


function renderCaste(data) {
  const colorMap = {
    General: "bg-indigo-500",
    OBC: "bg-green-500",
    SC: "bg-yellow-500 text-black",
    ST: "bg-red-500",
    EWS: "bg-purple-500",
    Other: "bg-gray-500"
  };

  return `
    <div class="mt-4">
      <div class="text-xs font-semibold text-gray-500 mb-2">
        Category Distribution
      </div>

      <!-- Stacked Bar -->
      <div class="w-full h-8 flex rounded-lg overflow-hidden shadow-inner bg-gray-200">
        ${
          Object.entries(data.caste_stats || {}).map(([caste, percent]) => `
            <div
              class="${colorMap[caste] || 'bg-gray-400'} flex items-center justify-center text-[10px] font-semibold text-white"
              style="width:${percent}%"
              title="${caste} ‚Äì ${percent}%"
            >
              ${percent >= 8 ? `${caste} ${percent}%` : ""}
            </div>
          `).join("")
        }
      </div>

      <!-- Legend -->
      <div class="mt-2 flex flex-wrap gap-2 text-[10px] text-gray-600">
        ${
          Object.keys(data.caste_stats || {}).map(caste => `
            <span class="flex items-center gap-1">
              <span class="w-2 h-2 rounded-full ${colorMap[caste] || 'bg-gray-400'}"></span>
              ${caste}
            </span>
          `).join("")
        }
      </div>
    </div>
  `;
}

</script>
<script>
function renderFees(data) {
  if (!data.fees_stats) return "";

  return `
    <div class="mt-5">
      <div class="text-xs font-semibold text-gray-500 mb-2">
        Fees Collection
      </div>

      <div class="w-full h-8 flex rounded-lg overflow-hidden shadow-inner bg-gray-200">

        <!-- Paid -->
        <div
          class="bg-emerald-500 flex items-center justify-center text-[11px] font-semibold text-white"
          style="width:${data.fees_stats.paid_percent}%"
          title="Paid ‚Äì ‚Çπ${data.fees_stats.paid}"
        >
          ${data.fees_stats.paid_percent >= 12
            ? `Paid ${data.fees_stats.paid_percent}%`
            : ""}
        </div>

        <!-- Pending -->
        <div
          class="bg-rose-500 flex items-center justify-center text-[11px] font-semibold text-white"
          style="width:${data.fees_stats.pending_percent}%"
          title="Pending ‚Äì ‚Çπ${data.fees_stats.pending}"
        >
          ${data.fees_stats.pending_percent >= 12
            ? `Pending ${data.fees_stats.pending_percent}%`
            : ""}
        </div>

      </div>

      <!-- Legend -->
      <div class="mt-2 flex gap-4 text-[10px] text-gray-600">
        <span class="flex items-center gap-1">
          <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
          Paid ‚Çπ${data.fees_stats.paid}
        </span>
        <span class="flex items-center gap-1">
          <span class="w-2 h-2 rounded-full bg-rose-500"></span>
          Pending ‚Çπ${data.fees_stats.pending}
        </span>
      </div>
    </div>
  `;
}
</script>
<script>
async function openTimetable(classId, sectionId, sectionName) {
  const modal = document.getElementById("timetableModal");
  const content = document.getElementById("timetableContent");
  const title = document.getElementById("timetableTitle");

  title.innerText = `Class ${classId} ‚Äì Section ${sectionName}`;
  content.innerHTML = "Loading timetable...";

  modal.classList.remove("hidden");
  modal.classList.add("flex");

  const res = await fetch(
    `https://erp.backend.smartbus360.com/timetable?class_id=${classId}&section_id=${sectionId}`,
    {
      headers: { Authorization: "Bearer " + window.ACCESS_TOKEN }
    }
  );

  const data = await res.json();

  if (!data.length) {
    content.innerHTML = "<p class='text-gray-500'>No timetable available</p>";
    return;
  }

  content.innerHTML = renderTimetableTable(data);
}

function closeTimetable() {
  const modal = document.getElementById("timetableModal");
  modal.classList.add("hidden");
  modal.classList.remove("flex");
}

function renderTimetableTable(data) {
  return `
    <table class="min-w-full border text-sm">
      <thead class="bg-gray-100">
        <tr>
          <th class="border px-3 py-2">Day</th>
          <th class="border px-3 py-2">Period</th>
          <th class="border px-3 py-2">Subject</th>
          <th class="border px-3 py-2">Teacher</th>
        </tr>
      </thead>
      <tbody>
        ${
          data.map(t => `
            <tr class="hover:bg-gray-50">
              <td class="border px-3 py-2">${t.weekday_id}</td>
              <td class="border px-3 py-2">${t.period_no}</td>
              <td class="border px-3 py-2">${t.subject_name}</td>
              <td class="border px-3 py-2">${t.teacher_name}</td>
            </tr>
          `).join("")
        }
      </tbody>
    </table>
  `;
}
</script>

{% endblock %}

{% endblock %}
